{% extends "admin/base_admin.html" %}

{% block title %}Print Order Labels - Admin - Purposefully Made KC{% endblock %}

{% block extra_css %}
<style>
/* Screen styles - controls and preview */
.print-controls {
    background: linear-gradient(135deg, #F5F0E1 0%, #E8D0B1 100%);
    border: 1px solid #B87C6F;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.print-controls h2 {
    margin-bottom: 1rem;
    color: var(--midnight-charcoal, #3A3D48);
}

.print-controls .filters {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1.5rem;
}

.print-controls .filters label {
    font-weight: 500;
    margin-right: 0.5rem;
}

.print-controls .filters select {
    padding: 0.5rem 1rem;
    border: 2px solid #E8D0B1;
    border-radius: 8px;
    font-size: 0.95rem;
}

.print-controls .filters .checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
}

.print-controls .filters .checkbox-group label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.print-btn {
    padding: 1rem 2rem;
    font-size: 1.1rem;
    font-weight: 600;
    background: linear-gradient(135deg, #B87C6F 0%, #7F6C50 100%);
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(184, 124, 111, 0.3);
    transition: transform 0.2s, box-shadow 0.2s;
}

.print-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(184, 124, 111, 0.4);
}

.print-btn svg {
    vertical-align: middle;
    margin-right: 0.5rem;
}

.labels-summary {
    margin-bottom: 2rem;
    padding: 1rem;
    background: #fff;
    border-radius: 8px;
    border: 1px solid #E8D0B1;
}

/* Label sheet - 3 columns × 10 rows = 30 per page */
/* Standard Avery 5160: 1" × 2.625" per label, 3×10 per sheet */
.labels-preview {
    background: #fff;
    max-width: 8.5in;
    margin: 0 auto;
}

.label-sheet {
    width: 8.5in;
    min-height: 11in;
    padding: 0.5in;
    margin-bottom: 2rem;
    box-sizing: border-box;
    background: #fff;
    border: 1px dashed #ccc;
    break-after: page;
}

.label-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(10, 1fr);
    gap: 0.125in 0.125in;
    width: 100%;
    height: 10in;
    box-sizing: border-box;
}

.label-cell {
    border: 1px solid #333;
    padding: 0.15in 0.2in;
    font-size: 9px;
    line-height: 1.3;
    overflow: hidden;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
}

.label-cell .label-order-num {
    font-weight: 700;
    font-size: 8px;
    color: #666;
    margin-bottom: 0.1in;
}

.label-cell .label-content {
    flex: 1;
}

.label-cell.shipping .label-content {
    font-family: inherit;
}

.label-cell.pickup .label-content {
    font-family: inherit;
}

/* Empty label cells */
.label-cell.empty {
    border-color: #ccc;
    background: #f9f9f9;
}

/* Print-specific styles */
@media print {
    .no-print,
    .navbar,
    .footer,
    .flash-messages {
        display: none !important;
    }
    
    body {
        padding: 0;
        margin: 0;
    }
    
    .admin-page {
        padding: 0 !important;
    }
    
    .labels-preview {
        max-width: none !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .label-sheet {
        width: 8.5in !important;
        min-height: 11in !important;
        padding: 0.5in !important;
        margin: 0 !important;
        border: none !important;
        break-after: page !important;
        page-break-after: always !important;
    }
    
    .label-sheet:last-child {
        break-after: auto !important;
        page-break-after: auto !important;
    }
    
    .label-grid {
        height: 10in !important;
        gap: 0.08in 0.08in !important;
    }
    
    .label-cell {
        border: 1px solid #000 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    
    .label-cell.empty {
        border: 1px dotted #999 !important;
        background: transparent !important;
    }
    
    @page {
        size: letter;
        margin: 0.5in;
    }
}
</style>
{% endblock %}

{% block admin_content %}
<div class="admin-page">
    <div class="container">
        <h1 class="no-print">Print Order Labels</h1>
        <p class="page-subtitle no-print">Print customer info labels for 3×10 sticker paper</p>
        
        <!-- Print Controls (hidden when printing) -->
        <div class="print-controls no-print">
            <h2>Options</h2>
            <form method="get" class="filters" id="filterForm">
                <div class="filters-row">
                    <div>
                        <label>Status:</label>
                        <label><input type="checkbox" name="status" value="paid" {% if 'paid' in selected_status %}checked{% endif %}> Paid</label>
                        <label><input type="checkbox" name="status" value="in_production" {% if 'in_production' in selected_status %}checked{% endif %}> In Production</label>
                        <label><input type="checkbox" name="status" value="new" {% if 'new' in selected_status %}checked{% endif %}> New</label>
                        <label><input type="checkbox" name="status" value="ready" {% if 'ready' in selected_status %}checked{% endif %}> Ready</label>
                    </div>
                </div>
                <div class="filters-row" style="margin-top: 1rem;">
                    <label for="collection">Collection:</label>
                    <select name="collection" id="collection">
                        <option value="">All Collections</option>
                        {% for c in collections %}
                        <option value="{{ c.id }}" {% if selected_collection == (c.id|string) %}selected{% endif %}>{{ c.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-outline" style="margin-left: 1rem;">Apply Filters</button>
                </div>
            </form>
            
            <div style="margin-top: 1.5rem;">
                <button type="button" class="print-btn" onclick="window.print()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 6 2 18 2 18 9"></polyline>
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                    </svg>
                    Print Labels
                </button>
            </div>
        </div>
        
        <div class="labels-summary no-print" style="margin-bottom: 1rem;">
            <strong>{{ orders|length }}</strong> order(s) → 
            <strong>{{ ((orders|length + 29) / 30)|int }}</strong> sheet(s) needed
        </div>
        
        {% if orders|length == 0 %}
        <div class="empty-state no-print" style="text-align: center; padding: 3rem; background: #fff; border-radius: 8px; border: 1px solid #E8D0B1;">
            <p style="font-size: 1.1rem; color: var(--text-secondary);">No orders match your filters. Adjust the status or collection above.</p>
        </div>
        {% else %}
        <!-- Label Sheets -->
        <div class="labels-preview">
            {% set labels_per_sheet = 30 %}
            {% set num_sheets = ((orders|length + 29) / labels_per_sheet)|int %}
            
            {% for sheet_num in range(num_sheets) %}
            <div class="label-sheet">
                <div class="label-grid">
                    {% for slot in range(labels_per_sheet) %}
                        {% set order_index = sheet_num * labels_per_sheet + slot %}
                        {% if order_index < orders|length %}
                            {% set order = orders[order_index] %}
                            <div class="label-cell {% if order.fulfillment_method == 'shipping' %}shipping{% else %}pickup{% endif %}">
                                <span class="label-order-num">{{ order.order_number }}</span>
                                <div class="label-content">
                                    {% if order.fulfillment_method == 'shipping' %}
                                        {# Shipping format: Name + Address #}
                                        {% set name_part = (order.first_name or '') ~ ' ' ~ (order.last_name or '') %}
                                        {% set recipient = order.shipping_recipient or name_part|trim or order.email or 'Customer' %}
                                        <strong>{{ recipient }}</strong><br>
                                        {% if order.shipping_street %}{{ order.shipping_street }}<br>{% endif %}
                                        {% if order.shipping_street_2 %}{{ order.shipping_street_2 }}<br>{% endif %}
                                        {% if order.shipping_city %}{{ order.shipping_city }}, {{ order.shipping_state }} {{ order.shipping_zip }}{% endif %}
                                        {% if order.shipping_country and order.shipping_country != 'USA' %}<br>{{ order.shipping_country }}{% endif %}
                                    {% else %}
                                        {# Pickup format: Name, Phone, Email #}
                                        {% set pickup_name = ((order.first_name or '') ~ ' ' ~ (order.last_name or ''))|trim %}
                                        <strong>{{ pickup_name or order.email or 'Customer' }}</strong><br>
                                        {% if order.phone %}{{ order.phone }}<br>{% endif %}
                                        {% if order.email %}{{ order.email }}{% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        {% else %}
                            <div class="label-cell empty"></div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
